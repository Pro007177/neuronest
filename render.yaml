# Render Blueprint specification: https://render.com/docs/blueprint-spec
# Defines the services needed for the NeuroNest application.

databases:
  # PostgreSQL Database Service (Free Tier)
  - name: neuronest-db         # Unique name for the database instance within Render
    databaseName: neuronest_db # The actual database name created inside PostgreSQL
    user: neuronest_user       # The database user Render will create
    plan: free                 # Use the free tier (sleeps after inactivity)
    region: oregon             # Optional: Choose a region

services:
  # Backend API Service (FastAPI)
  - type: web                  # A service that runs code and listens for HTTP requests
    name: neuronest-api        # Unique name for the backend service
    runtime: python            # Specify the runtime environment
    region: oregon             # Match the database region for lower latency
    rootDir: backend           # Specifies the directory containing the backend code
    plan: free                 # Use the free tier (sleeps after inactivity)
    buildCommand: |            # Commands to build the service (run in order)
      pip install --upgrade pip
      pip install -r requirements.txt
      alembic upgrade head      # Apply database migrations during build/deploy
    startCommand: "uvicorn app.main:app --host 0.0.0.0 --port $PORT" # Command to start the server ($PORT is set by Render)
    healthCheckPath: /api/health # Path Render uses to check if the service is healthy
    envVars:
      - key: PYTHON_VERSION
        value: 3.11
      - key: DATABASE_URL
        fromDatabase:
          name: neuronest-db
          property: connectionString
      - key: ANTHROPIC_API_KEY
        fromSecret: true
      - key: JWT_SECRET_KEY
        fromSecret: true
      - key: FRONTEND_ORIGIN     # URL of the deployed frontend for CORS
        fromService:
          type: web              # The frontend is now also type 'web'
          name: neuronest-web    # Must match the 'name' of the frontend service below
          property: url
      - key: APP_ENV
        value: production

  # Frontend Application Service (React Static Site)
  # CORRECTED: Use type: web and runtime: static
  - type: web                  # Use 'web' type for static sites now
    name: neuronest-web        # Unique name for the frontend service
    runtime: static            # Specify the 'static' runtime
    region: oregon             # Match other services' region
    rootDir: .                 # The root directory of the repository contains the frontend setup
    plan: free                 # Use the free tier
    buildCommand: |            # Commands to build the static site
      npm install
      npm run build
    staticPublishPath: build   # The directory containing the built static files
    envVars:
      # Environment variables needed by React *during build*
      - key: REACT_APP_API_URL
        fromService:
          type: web              # Get value from the backend web service
          name: neuronest-api    # Must match the 'name' of the backend service above
          property: url
    routes:
      # Rewrite rule for single-page applications (like React Router)
      - type: rewrite
        source: /*              # Match all paths
        destination: /index.html # Serve the main entry point